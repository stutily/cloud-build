jobs:
  drift-detection:
    docker:
      - image: google/cloud-sdk:slim
    steps:
      - checkout

      - run:
          name: Verify Identity
          command: |
            echo "Using GCP identity:"
            gcloud auth list

      - run:
          name: Trigger Cloud Build Drift Job
          command: |
            BUILD_ID=$(gcloud builds triggers run trigger-name \
              --region=europe-west1 \
              --format='value(metadata.build.id)')
            echo $BUILD_ID > build.txt
            echo "Triggered build: $BUILD_ID"

      - run:
          name: Poll for Completion
          command: |
            BUILD_ID=$(cat build.txt)
            echo "Polling build: $BUILD_ID"

            while true; do
              STATUS=$(gcloud builds describe "$BUILD_ID" \
                --region=europe-west1 \
                --format='value(status)')
              echo "Status: $STATUS"

              case "$STATUS" in
                SUCCESS)
                  break
                  ;;
                FAILURE|CANCELLED)
                  exit 2
                  ;;
                *)
                  sleep 5
                  ;;
              esac
            done

      - run:
          name: Stream Logs
          command: |
            BUILD_ID=$(cat build.txt)
            gcloud builds log "$BUILD_ID" --region=europe-west1

workflows:
  drift:
    jobs:
      - drift-detection

